from fastapi import FastAPI, HTTPException
import pandas as pd
from fastapi.middleware.cors import CORSMiddleware
import os

app = FastAPI(title="AI Retail Inventory API")

# Global variables to store the dataframes
forecast_df = pd.DataFrame()
inventory_df = pd.DataFrame()

# Allow CORS for Streamlit or other frontends
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"]
)

@app.on_event("startup")
async def load_data_on_startup():
    """Load the CSV files and store them in global variables.
    
    File paths are loaded from environment variables if set,
    otherwise they default to the names generated by main.py.
    """
    global forecast_df
    global inventory_df
    
    # --- Check for Environment Variables, fall back to default ---
    # Use os.getenv() to allow flexibility in file paths/names
    forecast_path = os.getenv("FORECAST_CSV_PATH", "RetailInventory_Demand_Forecast.csv")
    inventory_path = os.getenv("INVENTORY_CSV_PATH", "RetailInventory_Recommendations.csv")
    
    print(f"Attempting to load forecast data from: {forecast_path}")
    print(f"Attempting to load inventory data from: {inventory_path}")

    if not os.path.exists(forecast_path) or not os.path.exists(inventory_path):
        print("CRITICAL ERROR: One or both data CSVs not found. Please run main.py first to generate the defaults, or set FORECAST_CSV_PATH and INVENTORY_CSV_PATH environment variables.")
        return 

    # Load and clean data
    try:
        forecast_df = pd.read_csv(forecast_path)
        inventory_df = pd.read_csv(inventory_path)
        
        # Ensure 'Date' columns are strings for safe JSON serialization
        forecast_df['Date'] = pd.to_datetime(forecast_df['Date']).dt.strftime('%Y-%m-%d')
        inventory_df['Date'] = pd.to_datetime(inventory_df['Date']).dt.strftime('%Y-%m-%d')
        
        # Ensure the boolean restock flag is handled correctly
        inventory_df['restock_needed'] = inventory_df['restock_needed'].astype(bool)

        print("Data successfully loaded and prepared for API.")

    except Exception as e:
        print(f"Error loading data: {e}")
        forecast_df = pd.DataFrame()
        inventory_df = pd.DataFrame()


@app.get("/forecast")
def get_forecast(store_id: int = None, product_id: int = None):
    """
    Return predicted demand per store/product.
    """
    if forecast_df.empty:
        raise HTTPException(status_code=503, detail="Service Unavailable: Data not yet loaded.")
        
    data = forecast_df
    if store_id:
        data = data[data['Store_ID'] == store_id]
    if product_id:
        data = data[data['Product_ID'] == product_id]
        
    if data.empty and (store_id or product_id):
        raise HTTPException(status_code=404, detail="Requested store/product data not found.")
            
    return data.to_dict(orient='records')


@app.get("/inventory")
def get_inventory(store_id: int = None, product_id: int = None):
    """
    Return inventory recommendations per store/product.
    """
    if inventory_df.empty:
        raise HTTPException(status_code=503, detail="Service Unavailable: Data not yet loaded.")
    
    data = inventory_df
    if store_id:
        data = data[data['Store_ID'] == store_id]
    if product_id:
        data = data[data['Product_ID'] == product_id]

    if data.empty and (store_id or product_id):
        raise HTTPException(status_code=404, detail="Requested store/product data not found.")
            
    return data.to_dict(orient='records')